<!DOCTYPE html>
<meta charset="utf-8">
<style>

#content {
    position: absolute;
    top: 0px;
    left: 1100px;
}

</style>
<html>
<body>

<div id="map"></div>

<div id="content"></div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script>
var width = 500,
    height = 500;
var active;
var colors = {
    "A+": "#014924",
    "A": "#006B33",
    "B": "#01A33E",
    "C": "#8AFF01",
    "D": "#FFFF00",
    "E": "#FEC202",
    "F": "#FF7F00",
    "G": "#FD0100",
    "NC": "#6D6D6D"
};

var weights = {
    "A+": "7",
    "A": "23",
    "B": "43",
    "C": "73",
    "D": "102",
    "E": "131",
    "F": "160", 
    "G": "288"
};

var mapRange = {
    "A+": [0, 14],
    "A": [14, 29],
    "B": [29, 58],
    "C": [58, 87],
    "D": [87, 116],
    "E": [116, 145],
    "F": [145, 175],
    "G": [175, 400]
}

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height);

var svgContent = d3.select('#content').append('svg')

var gProv = svg.append("g").attr("transform", "translate(-400, -270) scale(5)").attr("class", "provinces_g");
var gMun = svg.append("g").attr("transform", "translate(-400, -270) scale(5)").attr("class", "municipalities_g");

var projProv = d3.geo.albers()
      .center([0, 41])
      .rotate([347, 0])
      .parallels([35, 45])
      .scale(2000)
      .translate([width / 2, height / 2]);

var pathProv = d3.geo.path()
      .projection(projProv);

var projMun = d3.geo.albers()
      .center([0, 41])
      .rotate([347, 0])
      .parallels([35, 45])
      .scale(2000)
      .translate([width / 2, height / 2]);

var pathMun = d3.geo.path()
      .projection(projMun)

function click(d) {
        createHighLevelDonut();

        console.info("click");
        if (active === d) return reset();
        gProv.selectAll(".active").classed("active", false);
        d3.select(this).classed("active", active = d);

        var b = pathProv.bounds(d);
        gProv.transition().duration(750).attr("transform",
            "translate(" + projProv.translate() + ")"
            + "scale(" + .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height) + ")"
            + "translate(" + -(b[1][0] + b[0][0]) / 2 + "," + -(b[1][1] + b[0][1]) / 2 + ")");

        createMunicipalities(d);
        gProv.attr("opacity", 0);
}

function createMunicipalities (d) {

    var municipalityData = foo; //To improve
    var resultData = bar; //To improve

    var subunitsMun = topojson.feature(municipalityData, municipalityData.objects.output)
    var municipalities = topojson.feature(municipalityData, municipalityData.objects.output).features
    
    var municipality = gMun.selectAll(".municipality").data(municipalities)
    gMun.attr("opacity", 1)
    // draw and style any feature at time
    municipality
    //.data(topojson.feature(it, it.objects.sub).features)
    .enter().append("path")
    .attr("class", "municipality")
    .attr("id",function (data) { return data.id; })
    .attr("d",pathMun)
    .style("stroke", "black")
    .style("stroke-width", 0.3)
    .style("fill", function (data) {
        console.info(data.id)
        var maxValue = 0;
        var maxKey = "";
        //console.info(resultData["feature"][d.id]["municipalities"]);
        if(resultData["feature"][d.id]["municipalities"][data.id] != undefined) {
           var mapColor = resultData["feature"][d.id]["municipalities"][data.id]["values"];
            var sum = 0;
            var sumUnits = 0;   
            for (var key in mapColor) {
                if(key === 'NC')
                        continue;
                sum += mapColor[key] * weights[key];
                sumUnits += mapColor[key];
            }
            var avg = sum / sumUnits;
            for (var key in mapRange) {
                if(avg >= mapRange[key][0] && avg < mapRange[key][1])
                        return colors[key];
            }
        }
    })
    .on("click", clickMun);

    var b = pathProv.bounds(d);
    gMun.transition().duration(10).attr("transform",
        "translate(" + projMun.translate() + ")"
        + "scale(" + .80 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height) + ")"
        + "translate(" + -(b[1][0] + b[0][0]) / 2 + "," + -(b[1][1] + b[0][1]) / 2 + ")");

}

function clickMun (d) {
    console.info("click mun");
    gProv.selectAll(".active").classed("active", active = false);
    gProv.transition().duration(750).attr("transform", "translate(-400, -270) scale(5)");

    gMun.selectAll(".active").classed("active", active = false);
    gMun.transition().duration(750).attr("transform", "translate(-400, -270) scale(5)");

    gProv.attr("opacity", 1);
    gMun.attr("opacity", 0);

    gMun.selectAll(".municipality").remove();
}

function createHighLevelDonut() {

    var outerRadius = 120;
    var innerRadius = outerRadius * .6;

    var data = [
        { "key": "A", "value": 70 },
        { "key": "B", "value": 50 },
        { "key": "C", "value": 20 },
        { "key": "D", "value": 30 },
        { "key": "E", "value": 60 },
        { "key": "F", "value": 10 },
        { "key": "G", "value" : 60 }
       ];

    var arc = d3.svg.arc()
          .outerRadius(outerRadius)
          .innerRadius(innerRadius);

    var pie = d3.layout.pie()
        .sort(null)
        .value(function(d) {
        return d.number; }
    );
/*
    var arcs = svgContent.selectAll("g.slice")
        .data(pie(data))
        .enter()
        .append("g")
        //.attr("transform", "translate(" + (width/2 - outerRadius) + "," + (outerRadius+50)  + ")")
        .attr("class", "slice");
       
    arcs.append("path")    
        .attr("fill", function(d, i) { return colors(i); } )
        .attr("d", arc)
        .transition()
        .ease("bounce")
        .duration(2500)
        .attrTween("d", tweenPie)
 
    arcs.append("text")
        .attr("font-family", "PT Serif")
        .attr("font-size", "medium")
        .transition()
        .delay(2700)
        .ease("elastic")
        .duration(2700)
        .attr("fill", "#333")                  
        .attr("transform", function(d) {                    
            var c = arc.centroid(d),
                  x = c[0],
                  y = c[1],
                  // pythagorean theorem for hypotenuse
                  h = Math.sqrt(x*x + y*y);
                  return "translate(" + (x/h * 140) +  ',' +
                                        (y/h * 140) +  ")";   
        });

    function tweenPie(b){
            b.innerRadius = 0;
            var i = d3.interpolate({startAngle:0, endAngle:0}, b);
            return function(t) { return arc(i(t)); };
    }

    function tweenDonut(b){
            b.innerRadius = 90 * .6;
            var i = d3.interpolate({innerRadius:0},b);
            return function(t) { return arc(i(t)); };
    } */
}

function reset() {
    gProv.selectAll(".active").classed("active", active = false);
    gProv.transition().duration(750).attr("transform", "translate(-400, -270) scale(5)");
}

queue()
    .defer(d3.json, "province.json")
    .defer(d3.json, "municipality.json")
    .defer(d3.json, "http://127.0.0.1:4000/energy/1.0/data")
    .await(ready);

function ready(error, provinceData, municipalityData, resultData) {
    foo = municipalityData
    bar = resultData
    //console.info(resultData);

    var subunitsProv = topojson.feature(provinceData, provinceData.objects.sub)
    var provinces = topojson.feature(provinceData, provinceData.objects.sub).features

    var province = gProv.selectAll(".province").data(provinces)
    // draw and style any feature at time
    province
    //.data(topojson.feature(it, it.objects.sub).features)
    .enter().append("path")
    .attr("class", "province")
    .attr("id",function(d) { return d.id; })
    .attr("d",pathProv)
    .style("stroke", "black")
    .style("stroke-width", 0.3)
    .style("fill", function (d) {
        var maxValue = 0;
        var maxKey = "";
        var mapColor = resultData["feature"][d.id]["values"];
        var sum = 0;
        var sumUnits = 0;   
        for (var key in mapColor) {
                if(key === 'NC')
                        continue;
                sum += mapColor[key] * weights[key];
                sumUnits += mapColor[key];
        }
        var avg = sum / sumUnits;
        for (var key in mapRange) {
                if(avg >= mapRange[key][0] && avg < mapRange[key][1])
                        return colors[key];
        }    
    })
    .on("click", click);
}


/*
function setColors (resultData) {

    var colors = new Object();
    var keyColors = resultData["feature"][1]["values"];

    console.info(keyColors);

    var valueColors = 
    
    for (var key in keyColors) {
        colors[key] = 
    }
*/

    /*
    colors["upload"] = "blue"
    colors["download"] = "orange"
    colors["conn_time"] = "purple"
    colors["num_client"] = "black"
    colors["num_sample"] = "black"
    colors["upload_difference"] = "green"
    colors["download_difference"] = "green"
    colors["conn_time_difference"] = "green"

    */

 
</script>
</body>
</html>
