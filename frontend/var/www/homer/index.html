<!DOCTYPE html>
<meta charset="utf-8">
<style>

#chart{
    position: absolute;
    top: 0px;
    left: 500px;
}

#charta{
    position: absolute;
    top: 30px;
    left: 980px;
}

#chart1{
    position: absolute;
    top: 270px;
    left: 500px;
}

#chartb{
    position: absolute;
    top: 300px;
    left: 980px;
}

.hidden { 
  display: none; 
}
div.tooltip {
  color: #222; 
  background: #fff; 
  padding: .5em; 
  text-shadow: #f5f5f5 0 1px 0;
  border-radius: 2px; 
  box-shadow: 0px 0px 2px 0px #a6a6a6; 
  opacity: 0.9; 
  position: absolute;
}


</style>
<html>
<body>

<div id="map"></div>

<div id="chart"></div>

<div id="charta"></div>

<div id="chart1"></div>

<div id="chartb"></div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script>
var width = 500,
    height = 500;
var active;
var colors = {
    "A+": "#014924",
    "A": "#006B33",
    "B": "#01A33E",
    "C": "#8AFF01",
    "D": "#FFFF00",
    "E": "#FEC202",
    "F": "#FF7F00",
    "G": "#FD0100",
    "NC": "#6D6D6D"
};

var weights = {
    "A+": "7",
    "A": "23",
    "B": "43",
    "C": "73",
    "D": "102",
    "E": "131",
    "F": "160", 
    "G": "288"
};

var mapRange = {
    "A+": [0, 14],
    "A": [14, 29],
    "B": [29, 58],
    "C": [58, 87],
    "D": [87, 116],
    "E": [116, 145],
    "F": [145, 175],
    "G": [175, 400]
}

var mapProvince = {
    "1": "Provincia di Torino",
    "2": "Provincia di Vercelli",
    "3": "Provincia di Novara",
    "4": "Provincia di Cuneo",
    "5": "Provincia di Asti",
    "6": "Provincia di Alessandria",
    "96": "Provincia di Biella",
    "103": "Provincia del Verbano-Cusio-Ossola"
};

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height);

var tooltip = d3.select("#map").append("div")
    .attr("class", "tooltip");

var gProv = svg.append("g").attr("transform", "translate(-400, -270) scale(5)").attr("class", "provinces_g");
var gMun = svg.append("g").attr("transform", "translate(-400, -270) scale(5)").attr("class", "municipalities_g");

var projProv = d3.geo.albers()
      .center([0, 41])
      .rotate([347, 0])
      .parallels([35, 45])
      .scale(2000)
      .translate([width / 2, height / 2]);

var pathProv = d3.geo.path()
      .projection(projProv);

var projMun = d3.geo.albers()
      .center([0, 41])
      .rotate([347, 0])
      .parallels([35, 45])
      .scale(2000)
      .translate([width / 2, height / 2]);

var pathMun = d3.geo.path()
      .projection(projMun)

function click(d) {
        createHighLevelDonut(d);

        if (active === d) return reset();
        gProv.selectAll(".active").classed("active", false);
        d3.select(this).classed("active", active = d);

        var b = pathProv.bounds(d);
        gProv.transition().duration(750).attr("transform",
            "translate(" + projProv.translate() + ")"
            + "scale(" + .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height) + ")"
            + "translate(" + -(b[1][0] + b[0][0]) / 2 + "," + -(b[1][1] + b[0][1]) / 2 + ")")
        .transition().duration(1000)
        .attr("opacity", 0);
        
        createMunicipalities(d);
        
        //gProv.attr("opacity", 0);

        cod = d;//To improve
}

function createMunicipalities (d) {

    var municipalityData = foo; //To improve
    var resultData = bar; //To improve

    var subunitsMun = topojson.feature(municipalityData, municipalityData.objects.output)
    var municipalities = topojson.feature(municipalityData, municipalityData.objects.output).features
    
    var municipality = gMun.selectAll(".municipality").data(municipalities)
    gMun.attr("opacity", 1)
    // draw and style any feature at time
    municipality
    //.data(topojson.feature(it, it.objects.sub).features)
    
    .enter().append("path")
    .attr("class", "municipality")
    .attr("id",function (data) { return data.id; })
    .attr("d",pathMun)
    .attr("opacity", 0)
    .on("click", clickMun)
    .on("mouseover", createLowLevelDonut)
    .on("mouseout", function(){
        document.getElementById("chart1").innerHTML = "";
        document.getElementById("chartb").innerHTML = "";
    })   
    .on("mousemove", function(data,i) {
        var mouse = d3.mouse(svg.node()).map( function(data) { return parseInt(data); } );

        tooltip
          .classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+25)+"px;top:"+mouse[1]+"px")
          .html(resultData["feature"][d.id]["municipalities"][data.id]["name"]);
    })
    .transition()
    .delay(1000)
    .duration(750)
    .attr("opacity", 1)
    .style("stroke", "black")
    .style("stroke-width", 0.1)
    .style("fill", function (data) {
        var maxValue = 0;
        var maxKey = "";
        //console.info(resultData["feature"][d.id]["municipalities"]);
        if(resultData["feature"][d.id]["municipalities"][data.id] != undefined) {
           var mapColor = resultData["feature"][d.id]["municipalities"][data.id]["values"]; 
            var sum = 0;
            var sumUnits = 0;   
            for (var key in mapColor) {
                if(key === 'NC')
                        continue;
                sum += mapColor[key] * weights[key];
                sumUnits += mapColor[key];
            }
            var avg = sum / sumUnits;
            for (var key in mapRange) {
                if(avg >= mapRange[key][0] && avg < mapRange[key][1])
                        return colors[key];
            }
        } else return "white";
    })
    
 
    var b = pathProv.bounds(d);
    gMun.transition().duration(10).attr("transform",
        "translate(" + projMun.translate() + ")"
        + "scale(" + .80 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height) + ")"
        + "translate(" + -(b[1][0] + b[0][0]) / 2 + "," + -(b[1][1] + b[0][1]) / 2 + ")");

}

function clickMun (d) {
    gProv.selectAll(".active").classed("active", active = false);
    gProv.transition().duration(750).attr("transform", "translate(-400, -270) scale(5)");

    gMun.selectAll(".active").classed("active", active = false);
    gMun.transition().duration(750).attr("transform", "translate(-400, -270) scale(5)");

    gProv.attr("opacity", 1);
    gMun.attr("opacity", 0);

    gMun.selectAll(".municipality").remove();
    document.getElementById("chart").innerHTML = "";
    document.getElementById("charta").innerHTML = "";
    document.getElementById("chart1").innerHTML = "";
    document.getElementById("chartb").innerHTML = "";
}

function createHighLevelDonut(d) {

    var resultData = bar;

    var margin = {top: 1, right: 1, bottom: 6, left: 1},
    width = 580 - margin.left - margin.right,
    height = 260 - margin.top - margin.bottom;
    color = d3.scale.category20c();
    outerRadius = 80;
    innerRadius = outerRadius * .6;

    d3.select("#chart").attr("height", height);

    var data = new Array();

    for(var key in resultData["feature"][d.id]["values"]){
        data.push({"key": key, "value": resultData["feature"][d.id]["values"][key]})

    }

     var legend = d3.select("#charta").append("svg")
      .attr("class", "legend")
      .attr("width", 400)
      .attr("height", 250)
    .selectAll("g")
      .data(data)
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", function(d,i){return colorDonut(i)});

  legend.append("text")
      .attr("x", 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .text(function(d, i) { return data[i].key +": "+ data[i].value; });

    var arc = d3.svg.arc()
              .outerRadius(outerRadius)
              .innerRadius(innerRadius);

    var pie = d3.layout.pie()
               .sort(null)
               .value(function(d) {
                return d.value; }
              );

    var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        
    var arcs = svg.selectAll("g.slice")
        .data(pie(data))
        .enter()
            .append("g")
            .attr("transform", "translate(" + (width/2 - outerRadius) + "," + (outerRadius+50)  + ")")
            .attr("class", "slice");

        arcs.append("path")    
            .attr("fill", function(d, i) { return colorDonut(i); } )
            .attr("d", arc)
            .transition()
              .ease("bounce")
              .duration(2500)
              .attrTween("d", tweenPie)

        arcs.append("text")
           .attr("font-family", "PT Serif")
           .attr("font-size", "medium")
           .transition()
           .delay(2700)
           .ease("elastic")
              .duration(2700)
           .attr("fill", "#333");                 
           /*.attr("transform", function(d, i) {                    
                var c = arc.centroid(d),
                x = c[0],
                y = c[1],
                // pythagorean theorem for hypotenuse
                h = Math.sqrt(x*x + y*y);
                if(i%2 == 0) {
                    return "translate(" + (x/h * 115) +  ',' +
                                        (y/h * 115) +  ")";   
                    
                }
                 return "translate(" + (x/h * 100) +  ',' +
                                        (y/h * 100) +  ")";   
            })
            .attr("text-anchor", function(d) {
                return (d.endAngle + d.startAngle)/2 > Math.PI ?
                "end" : "start";
            })                       
            .text(function(d, i) { return data[i].key +": "+ data[i].value; });*/

    function tweenPie(b){
        b.innerRadius = 0;
        var i = d3.interpolate({startAngle:0, endAngle:0}, b);
        return function(t) { return arc(i(t)); };
      }

    function tweenDonut(b){
        b.innerRadius = 90 * .6;
        var i = d3.interpolate({innerRadius:0},b);
        return function(t) { return arc(i(t)); };
      }

    function colorDonut(i) {
        var count = 0;
        for(var key in colors) {
            if(count === i) {
                return colors[key]
            }
            count ++;
        }
    }
}

function createLowLevelDonut(d) {
    var resultData = bar;

    var margin = {top: 1, right: 1, bottom: 6, left: 1},
    width = 580 - margin.left - margin.right,
    height = 260 - margin.top - margin.bottom;
    color = d3.scale.category20c();
    outerRadius = 80;
    innerRadius = outerRadius * .6;

    d3.select("#chart1").attr("height", height);

    var data = new Array();
    if(resultData["feature"][cod.id] != undefined && resultData["feature"][cod.id]["municipalities"][d.id] != undefined) { 
        for(var key in resultData["feature"][cod.id]["municipalities"][d.id]["values"]){
            data.push({"key": key, "value": resultData["feature"][cod.id]["municipalities"][d.id]["values"][key]})
        }
    }

      var legend = d3.select("#chartb").append("svg")
      .attr("class", "legend")
      .attr("width", 400)
      .attr("height", 300)
    .selectAll("g")
      .data(data)
    .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", function(d,i){return colorDonut(i)});

  legend.append("text")
      .attr("x", 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .text(function(d, i) { return data[i].key +": "+ data[i].value; });

    var arc = d3.svg.arc()
              .outerRadius(outerRadius)
              .innerRadius(innerRadius);

    var pie = d3.layout.pie()
               .sort(null)
               .value(function(d) {
                return d.value; }
              );

    var svg = d3.select("#chart1").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        
    var arcs = svg.selectAll("g.slice")
        .data(pie(data))
        .enter()
            .append("g")
            .attr("transform", "translate(" + (width/2 - outerRadius) + "," + (outerRadius+50)  + ")")
            .attr("class", "slice");

        arcs.append("path")    
            .attr("fill", function(d, i) { return colorDonut(i); } )
            .attr("d", arc)
            .transition()
              .ease("bounce")
              .duration(2500)
              .attrTween("d", tweenPie)

        /*arcs.append("text")
           .attr("font-family", "PT Serif")
           .attr("font-size", "medium")
           .transition()
           .delay(2700)
           .ease("elastic")
              .duration(2700)
           .attr("fill", "#333")                  
           .attr("transform", function(d) {                    
                var c = arc.centroid(d),
                x = c[0],
                y = c[1],
                // pythagorean theorem for hypotenuse
                h = Math.sqrt(x*x + y*y);
                return "translate(" + (x/h * 115) +  ',' +
                                      (y/h * 115) +  ")";   
                })
            .attr("text-anchor", function(d) {
                return (d.endAngle + d.startAngle)/2 > Math.PI ?
                "end" : "start";
            })                       
            .text(function(d, i) { return data[i].key +": "+ data[i].value; });*/

    function tweenPie(b){
        b.innerRadius = 0;
        var i = d3.interpolate({startAngle:0, endAngle:0}, b);
        return function(t) { return arc(i(t)); };
      }

    function tweenDonut(b){
        b.innerRadius = 90 * .6;
        var i = d3.interpolate({innerRadius:0},b);
        return function(t) { return arc(i(t)); };
      }

    function colorDonut(i) {
        var count = 0;
        for(var key in colors) {
            if(count === i) {
                return colors[key]
            }
            count ++;
        }
    }
}

function reset() {
    gProv.selectAll(".active").classed("active", active = false);
    gProv.transition().duration(750).attr("transform", "translate(-400, -270) scale(5)");
}

queue()
    .defer(d3.json, "province.json")
    .defer(d3.json, "municipality.json")
    .defer(d3.json, "http://127.0.0.1:4000/energy/1.0/data")
    .await(ready);

function ready(error, provinceData, municipalityData, resultData) {
    foo = municipalityData
    bar = resultData
    //console.info(resultData);

    var subunitsProv = topojson.feature(provinceData, provinceData.objects.sub)
    var provinces = topojson.feature(provinceData, provinceData.objects.sub).features

    var province = gProv.selectAll(".province").data(provinces)
    // draw and style any feature at time
    province
    //.data(topojson.feature(it, it.objects.sub).features)
    .enter().append("path")
    .attr("class", "province")
    .attr("id",function(d) { return d.id; })
    .attr("d",pathProv)
    .style("stroke", "black")
    .style("stroke-width", 0.3)
    .style("fill", function (d) {
        var maxValue = 0;
        var maxKey = "";
        var mapColor = resultData["feature"][d.id]["values"];
        var sum = 0;
        var sumUnits = 0;   
        for (var key in mapColor) {
                if(key === 'NC')
                        continue;
                sum += mapColor[key] * weights[key];
                sumUnits += mapColor[key];
        }
        var avg = sum / sumUnits;
        for (var key in mapRange) {
                if(avg >= mapRange[key][0] && avg < mapRange[key][1])
                        return colors[key];
        }    
    })
    .on("mousemove", function(d,i) {
        var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );

        tooltip
          .classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+25)+"px;top:"+mouse[1]+"px")
          .html(mapProvince[d.id])
    })
    .on("mouseout",  function(d,i) {
        tooltip.classed("hidden", true)
    })
    .on("click", click);
}

</script>
</body>
</html>
